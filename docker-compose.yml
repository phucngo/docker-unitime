# Licensed to The Apereo Foundation under one or more contributor license
# agreements. See the NOTICE file distributed with this work for
# additional information regarding copyright ownership.
#
# The Apereo Foundation licenses this file to you under the Apache License,
# Version 2.0 (the "License"); you may not use this file except in
# compliance with the License. You may obtain a copy of the License at:
#
# http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
#
# See the License for the specific language governing permissions and
# limitations under the License.

services:
    unitime-db:
        container_name: unitime-db
        command: --default-authentication-plugin=mysql_native_password
        environment: 
            - MYSQL_RANDOM_ROOT_PASSWORD=yes
            - MYSQL_USER=timetable
            - MYSQL_PASSWORD=unitime
            - MYSQL_DATABASE=timetable
        build:
            context: ./docker/mysql/
            dockerfile: mysql.Dockerfile
        expose:
            - 3306
        volumes:
            - "unitime-db:/var/lib/mysql"

    unitime-phpmyadmin:
        image: phpmyadmin/phpmyadmin:latest
        depends_on:
            - unitime-db
        environment:
            - PMA_HOST=unitime-db
            - PMA_PORT=3306
            - PMA_USER=timetable
            - PMA_PASSWORD=unitime
        ports:
            - 8081:80
        restart: unless-stopped
        
    unitime-web:
        container_name: unitime-web
        depends_on:
            - unitime-db
        environment:
            - JAVA_OPTS=-Dconnection.url=jdbc:mysql://unitime-db:3306/timetable
        build:
            context: ./docker/tomcat/
            dockerfile: tomcat.Dockerfile
        ports:
            - 8888:8080
        labels:
             - traefik.enable=true
             - traefik.http.routers.unitime-web.rule=Host(`unitime.xiontechsolution.com`)
             - traefik.http.routers.unitime-web.entrypoints=websecure
             - traefik.http.routers.unitime-web.tls=true
             - traefik.http.routers.unitime-web.middlewares=cors@docker
             - traefik.http.middlewares.cors.headers.accesscontrolalloworigin=*
             - traefik.http.middlewares.cors.headers.accesscontrolallowmethods=GET,OPTIONS,PUT,POST,DELETE
             - traefik.http.middlewares.cors.headers.accesscontrolallowheaders=*

        volumes:
            - "unitime-data:/usr/local/tomcat/data"

volumes:
    unitime-data:
    unitime-db:
